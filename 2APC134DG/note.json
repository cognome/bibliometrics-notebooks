{
  "paragraphs": [
    {
      "text": "%md\n\n##### Memo:\n- Add state names\n- See \u0027Known City Identification Issues\u0027 at the end",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "editorHide": false,
        "editorMode": "ace/mode/markdown",
        "enabled": true,
        "tableHide": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431526549221_-871133890",
      "id": "20150513-141549_31078792",
      "dateCreated": "May 13, 2015 2:15:49 PM",
      "dateStarted": "Mar 4, 2016 10:12:07 AM",
      "dateFinished": "Mar 4, 2016 10:12:07 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Configuration",
      "text": "val NumPartitions \u003d 32\nval OptSaveMode: Option[org.apache.spark.sql.SaveMode] \u003d Some(org.apache.spark.sql.SaveMode.Overwrite/*ErrorIfExists*/)\nval DatasetId \u003d 1\nval StudyName \u003d \"anticipation\"\n\nval GeonamesDir \u003d \"/tmp/geonames\"\nval WorkDir \u003d s\"/tmp/$StudyName\"\nval ProcessingDir \u003d s\"$WorkDir/processing\"\nval DisambigDir \u003d s\"$WorkDir/disambiguation\"",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431440621873_860114606",
      "id": "20150512-142341_1999601151",
      "dateCreated": "May 12, 2015 2:23:41 PM",
      "dateStarted": "Mar 4, 2016 10:12:07 AM",
      "dateFinished": "Mar 4, 2016 10:12:08 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Institutions",
      "text": "val institutions \u003d sqlc.read.parquet(s\"$ProcessingDir/institutions.parquet\").filter(\u0027did \u003d\u003d\u003d DatasetId \u0026\u0026 \u0027is_valid \u003d\u003d\u003d true).repartition(NumPartitions).persist(org.apache.spark.storage.StorageLevel.MEMORY_ONLY_SER)\n\ninstitutions.registerTempTable(\"institutions\")",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "title": true,
        "editorHide": false,
        "editorMode": "ace/mode/scala",
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431505855510_-1301712908",
      "id": "20150513-083055_2047211475",
      "dateCreated": "May 13, 2015 8:30:55 AM",
      "dateStarted": "Mar 4, 2016 10:12:07 AM",
      "dateFinished": "Mar 4, 2016 10:12:09 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "institutions.printSchema()",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431505854235_-181339435",
      "id": "20150513-083054_1680271764",
      "dateCreated": "May 13, 2015 8:30:54 AM",
      "dateStarted": "Mar 4, 2016 10:12:08 AM",
      "dateFinished": "Mar 4, 2016 10:12:09 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select * from institutions limit 8",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "did",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "did",
              "index": 0.0,
              "aggr": "sum"
            }
          }
        },
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431521679309_768739328",
      "id": "20150513-125439_133558045",
      "dateCreated": "May 13, 2015 12:54:39 PM",
      "dateStarted": "Mar 4, 2016 10:12:09 AM",
      "dateFinished": "Mar 4, 2016 10:12:10 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Countries",
      "text": "val countries \u003d sqlc.read.parquet(\n    s\"$GeonamesDir/countries.parquet\"\n).filter(\n    \u0027geoname_id.isNotNull // geoname_id is null for \u0027Netherlands Antilles\u0027 and \u0027Serbia and Montenegro\u0027 which don\u0027t exist anymore\n).select(\n    \u0027geoname_id, \u0027iso, \u0027name, \u0027continent_name\n).withColumnRenamed(\n    \"geoname_id\", \"country_geoname_id\"\n).repartition(NumPartitions).persist(org.apache.spark.storage.StorageLevel.MEMORY_ONLY_SER)\n\ncountries.registerTempTable(\"countries\")",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "title": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431507030226_-1847002791",
      "id": "20150513-085030_979633983",
      "dateCreated": "May 13, 2015 8:50:30 AM",
      "dateStarted": "Mar 4, 2016 10:12:09 AM",
      "dateFinished": "Mar 4, 2016 10:12:10 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "countries.printSchema()",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431507114197_-295989674",
      "id": "20150513-085154_564323794",
      "dateCreated": "May 13, 2015 8:51:54 AM",
      "dateStarted": "Mar 4, 2016 10:12:10 AM",
      "dateFinished": "Mar 4, 2016 10:12:11 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select * from countries limit 8",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "country_geoname_id",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "iso",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "country_geoname_id",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "iso",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431508926708_-1195928863",
      "id": "20150513-092206_1655060450",
      "dateCreated": "May 13, 2015 9:22:06 AM",
      "dateStarted": "Mar 4, 2016 10:12:11 AM",
      "dateFinished": "Mar 4, 2016 10:12:11 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select continent_name, count(*) c from countries group by continent_name order by c desc",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "continent_name",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "c",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "continent_name",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "c",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431522946163_-1491480980",
      "id": "20150513-131546_1203422245",
      "dateCreated": "May 13, 2015 1:15:46 PM",
      "dateStarted": "Mar 4, 2016 10:12:11 AM",
      "dateFinished": "Mar 4, 2016 10:12:12 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "val onlyAsciiUDF \u003d udf { (a: Seq[String]) \u003d\u003e a.filter(_.matches(\"\"\"[\\x00-\\x7F]+\"\"\")) } // (\\p{ASCII} is not recognized so we use the equivalent instead",
      "dateUpdated": "Mar 4, 2016 5:35:17 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431521805882_-1899342697",
      "id": "20150513-125645_431793424",
      "dateCreated": "May 13, 2015 12:56:45 PM",
      "dateStarted": "Mar 4, 2016 10:12:11 AM",
      "dateFinished": "Mar 4, 2016 10:12:13 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Cities (population \u003e\u003d 500)",
      "text": "val cities \u003d sqlc.read.parquet(\n    s\"$GeonamesDir/allCountries.parquet\"\n).filter(\n    \u0027feature_class \u003d\u003d\u003d \"P\" \u0026\u0026 \u0027population \u003e\u003d 500\n).withColumn(\n    \"ascii_alternate_names\", onlyAsciiUDF(\u0027alternate_names)\n).select(\n    \u0027geoname_id, \u0027ascii_name, \u0027ascii_alternate_names, \u0027latitude, \u0027longitude, \u0027feature_class, \u0027feature_code, \u0027admin_1_code, \u0027country_iso\n).withColumnRenamed(\n    \"geoname_id\", \"city_geoname_id\"\n).withColumnRenamed(\n    \"admin_1_code\", \"state\"\n).repartition(NumPartitions).persist(org.apache.spark.storage.StorageLevel.MEMORY_ONLY_SER)\n\ncities.registerTempTable(\"cities\")",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "title": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431505976465_2010775908",
      "id": "20150513-083256_1444874795",
      "dateCreated": "May 13, 2015 8:32:56 AM",
      "dateStarted": "Mar 4, 2016 10:12:13 AM",
      "dateFinished": "Mar 4, 2016 10:12:13 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "cities.printSchema()",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431507916893_583683109",
      "id": "20150513-090516_41945377",
      "dateCreated": "May 13, 2015 9:05:16 AM",
      "dateStarted": "Mar 4, 2016 10:12:13 AM",
      "dateFinished": "Mar 4, 2016 10:12:14 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select * from cities limit 8",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "city_geoname_id",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "ascii_name",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "yAxis": {
              "name": "ascii_name",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "editorHide": false,
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431521708487_853045310",
      "id": "20150513-125508_26961043",
      "dateCreated": "May 13, 2015 12:55:08 PM",
      "dateStarted": "Mar 4, 2016 10:12:14 AM",
      "dateFinished": "Mar 4, 2016 10:12:22 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select feature_code, count(*) c from cities group by feature_code order by c desc",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "feature_code",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "c",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "feature_code",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "c",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431522540624_995336696",
      "id": "20150513-130900_1631006924",
      "dateCreated": "May 13, 2015 1:09:00 PM",
      "dateStarted": "Mar 4, 2016 10:12:14 AM",
      "dateFinished": "Mar 4, 2016 10:12:24 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Metrics",
      "text": "println(\"cities: \" + cities.count())\nprintln(\"countries: \" + countries.count())\nprintln(\"\")\nprintln(\"cities without ASCII alternate names: \" + cities.filter(\"size(ascii_alternate_names) \u003c 1\").count())\nprintln(\"cities without state: \" + cities.filter(\"state is null\").count())",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "editorHide": false,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "tableHide": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431505884725_-1911693156",
      "id": "20150513-083124_1575180802",
      "dateCreated": "May 13, 2015 8:31:24 AM",
      "dateStarted": "Mar 4, 2016 10:12:22 AM",
      "dateFinished": "Mar 4, 2016 10:12:25 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Sanity checks",
      "text": "/*\n- geoname ids are not null\n- geoname ids are the keys\n*/\n\nassert(cities.filter(\"city_geoname_id is null\").count() \u003d\u003d 0)\nassert(countries.filter(\"country_geoname_id is null\").count() \u003d\u003d 0)\n\nassert(cities.count() \u003d\u003d cities.select(\u0027city_geoname_id).distinct.count())\nassert(countries.count() \u003d\u003d countries.select(\u0027country_geoname_id).distinct.count())",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431505886101_-569688993",
      "id": "20150513-083126_86387026",
      "dateCreated": "May 13, 2015 8:31:26 AM",
      "dateStarted": "Mar 4, 2016 10:12:24 AM",
      "dateFinished": "Mar 4, 2016 10:12:29 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select * from cities where instr(ascii_name, \u0027-\u0027) \u003e 0 limit 8",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "city_geoname_id",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "ascii_name",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "yAxis": {
              "name": "ascii_name",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "title": false,
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431523582297_-1168007846",
      "id": "20150513-132622_2020892391",
      "dateCreated": "May 13, 2015 1:26:22 PM",
      "dateStarted": "Mar 4, 2016 10:12:25 AM",
      "dateFinished": "Mar 4, 2016 10:12:29 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select * from countries where instr(name, \u0027-\u0027) \u003e 0 limit 8",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "country_geoname_id",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "iso",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "country_geoname_id",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "iso",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431523629378_1504720169",
      "id": "20150513-132709_262335707",
      "dateCreated": "May 13, 2015 1:27:09 PM",
      "dateStarted": "Mar 4, 2016 10:12:29 AM",
      "dateFinished": "Mar 4, 2016 10:12:29 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select * from cities where ascii_name \u003d \"Hong Kong\"",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "city_geoname_id",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "ascii_name",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "city_geoname_id",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "ascii_name",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431524101374_-1834842276",
      "id": "20150513-133501_181480363",
      "dateCreated": "May 13, 2015 1:35:01 PM",
      "dateStarted": "Mar 4, 2016 10:12:29 AM",
      "dateFinished": "Mar 4, 2016 10:12:30 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select * from countries where name \u003d \"China\" OR name \u003d \"Hong Kong\"",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "country_geoname_id",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "iso",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "yAxis": {
              "name": "iso",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431524165767_-1962286107",
      "id": "20150513-133605_1342754672",
      "dateCreated": "May 13, 2015 1:36:05 PM",
      "dateStarted": "Mar 4, 2016 10:12:30 AM",
      "dateFinished": "Mar 4, 2016 10:12:30 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "cities.filter(\"array_contains(ascii_alternate_names, ascii_name) \u003d true\").count()",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431523658067_212009838",
      "id": "20150513-132738_980575661",
      "dateCreated": "May 13, 2015 1:27:38 PM",
      "dateStarted": "Mar 4, 2016 10:12:30 AM",
      "dateFinished": "Mar 4, 2016 10:12:30 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Normalization mappings",
      "text": "val ukStatesMap \u003d sc.broadcast(Map(\n    \"wales\" -\u003e \"wls\",\n    \"scotland\" -\u003e \"sct\",\n    \"northern ireland\" -\u003e \"nir\",\n    \"england\" -\u003e \"eng\"))\n\nval countryNameMapping \u003d sc.broadcast(Map(\n    \"peoples r china\" -\u003e \"china\",\n    \"north ireland\" -\u003e \"united kingdom\",\n    \"cote ivoire\" -\u003e \"ivory coast\",\n    \"bosnia \u0026 herceg\" -\u003e \"bosnia and herzegovina\",\n    \"u arab emirates\" -\u003e \"united arab emirates\",\n    \"papua n guinea\" -\u003e \"papua new guinea\",\n    \"rep of georgia\" -\u003e \"georgia\",\n    \"zaire\" -\u003e \"democratic republic of the congo\",\n    \"congo\" -\u003e \"democratic republic of the congo\", // Could be use for \u0027Republic of the Congo\u0027 but this will not introduce identification error\n    \"fr polynesia\" -\u003e \"french polynesia\",\n    \"mongol peo rep\" -\u003e \"mongolia\",\n    \"st kitts \u0026 nevi\" -\u003e \"saint kitts and nevis\",\n    \"dominican rep\" -\u003e \"dominican republic\",\n    \"neth antilles\" -\u003e \"netherlands antilles\",\n    \"byelarus\" -\u003e \"belarus\"))\n\nval cityNameMapping \u003d sc.broadcast(Map(\n    \"tubingen\" -\u003e \"tuebingen\",\n    \"freising weihenstephan\" -\u003e \"freising\"))\n\n// FIXME after admin1CodesASCII.txt integration\nval stateNameMapping \u003d sc.broadcast(Map(\n    \"qld\" -\u003e \"04\")) // AU.04 Queensland",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431526524325_314631572",
      "id": "20150513-141524_1344378738",
      "dateCreated": "May 13, 2015 2:15:24 PM",
      "dateStarted": "Mar 4, 2016 10:12:30 AM",
      "dateFinished": "Mar 4, 2016 10:12:31 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Normalization helpers",
      "text": "def clean(s: String): String \u003d s.toLowerCase().replace(\"-\", \" \")\n\nval cleanUDF \u003d udf { (s: String) \u003d\u003e clean(s) }\n\nval cleanAlternateNamesUDF \u003d udf { (a: Seq[String], x: String) \u003d\u003e if (!a.isEmpty) a.map(clean).filterNot(_ \u003d\u003d x) else a }\n\ndef properCountryName(s: String): String \u003d countryNameMapping.value.getOrElse(s, s)\n\nval properCountryNameUDF \u003d udf { (s: String) \u003d\u003e properCountryName(s) }\n\nval north \u003d \"^n (.*)\".r\nval south \u003d \"^s (.*)\".r\nval east \u003d \"^e (.*)\".r\nval west \u003d \"^w (.*)\".r\nval fort \u003d \"^ft (.*)\".r\nval park \u003d \"^(.*) pk$\".r\nval station \u003d \"^(.*) stn$\".r\nval island \u003d \"^(.*) isl$\".r\nval heights \u003d \"^(.*) hts$\".r\nval junction \u003d \"^(.*) jct$\".r\n\ndef properCityName(s: String): String \u003d cityNameMapping.value.getOrElse(s, \"\"\"^st(?\u003de? )\"\"\".r.replaceFirstIn(s, \"saint\") match {\n    case north(c) \u003d\u003e s\"north $c\"\n    case south(c) \u003d\u003e s\"south $c\"\n    case east(c) \u003d\u003e s\"east $c\"\n    case west(c) \u003d\u003e s\"west $c\"\n    case fort(c) \u003d\u003e s\"fort $c\"\n    case park(c) \u003d\u003e s\"$c park\"\n    case station(c) \u003d\u003e s\"$c station\"\n    case island(c) \u003d\u003e s\"$c island\"\n    case heights(c) \u003d\u003e s\"$c heights\"\n    case junction(c) \u003d\u003e s\"$c junction\"\n    case e \u003d\u003e e\n})\nval properCityNameUDF \u003d udf { (s: String) \u003d\u003e properCityName(s) }\n\nval properCityNameArrayUDF \u003d udf { (a: Seq[String]) \u003d\u003e a.map(properCityName) }",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431526756198_-410129731",
      "id": "20150513-141916_992488643",
      "dateCreated": "May 13, 2015 2:19:16 PM",
      "dateStarted": "Mar 4, 2016 10:12:31 AM",
      "dateFinished": "Mar 4, 2016 10:12:32 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Cities2",
      "text": "val cities2 \u003d cities.withColumn(\n    \"algo_city_name\", properCityNameUDF(cleanUDF(\u0027ascii_name))\n).withColumn(\n    \"algo_city_alternate_names\", properCityNameArrayUDF(cleanAlternateNamesUDF(\u0027ascii_alternate_names, \u0027algo_city_name))\n).withColumn(\n    \"algo_state\", cleanUDF(\u0027state)\n).persist(org.apache.spark.storage.StorageLevel.MEMORY_ONLY_SER)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431526887595_-167537065",
      "id": "20150513-142127_63610168",
      "dateCreated": "May 13, 2015 2:21:27 PM",
      "dateStarted": "Mar 4, 2016 10:12:31 AM",
      "dateFinished": "Mar 4, 2016 10:12:33 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Countries2",
      "text": "val countries2 \u003d countries.withColumn(\n    \"algo_country_name\", properCountryNameUDF(cleanUDF(\u0027name))\n).persist(org.apache.spark.storage.StorageLevel.MEMORY_ONLY_SER)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431528250560_-693145102",
      "id": "20150513-144410_1670108466",
      "dateCreated": "May 13, 2015 2:44:10 PM",
      "dateStarted": "Mar 4, 2016 10:12:33 AM",
      "dateFinished": "Mar 4, 2016 10:12:33 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "GeoNames maps",
      "text": "import org.apache.spark.sql.Row\n\nval countriesMap \u003d sc.broadcast(countries.select(\u0027name, \u0027country_geoname_id).map(r \u003d\u003e clean(r.getString(0)) -\u003e r.getInt(1)).collect().toMap)\n\nval countryCityState \u003d cities2.join(\n    countries, \u0027country_iso \u003d\u003d\u003d \u0027iso\n).select(\n    \u0027country_geoname_id, \u0027algo_city_name, \u0027algo_city_alternate_names, \u0027algo_state, \u0027city_geoname_id\n).map { r \u003d\u003e\n    val cityName \u003d r.getString(1)\n    val countryId \u003d if (cityName !\u003d \"hong kong\") r.getInt(0) else 1814991 // Hong Kong as a part of China\n    val cityAlternateNames \u003d r.getSeq[String](2)\n    val state \u003d r.getString(3)\n    val cityId \u003d r.getInt(4)\n    \n    (countryId, cityName, cityAlternateNames, state) -\u003e collection.mutable.Set(cityId)\n}\n\nval citiesMap \u003d sc.broadcast(countryCityState.map { case ((countryId, cityName, _, _), cityIds) \u003d\u003e\n    (countryId, cityName) -\u003e cityIds\n}.reduceByKey(_ ++\u003d _).collect().toMap)\n\nval citiesAlternateMap \u003d sc.broadcast(countryCityState.flatMap { case ((countryId, _, cityAlternateNames, _), cityIds) \u003d\u003e\n    cityAlternateNames.map(n \u003d\u003e (countryId, n) -\u003e cityIds)\n}.reduceByKey(_ ++\u003d _).collect().toMap)\n\nval statesMap \u003d sc.broadcast(countryCityState.map { case ((countryId, cityName, _, state), cityIds) \u003d\u003e\n    (countryId, cityName, state) -\u003e cityIds\n}.reduceByKey(_ ++\u003d _).collect().toMap)\n\nval statesAlternateMap \u003d sc.broadcast(countryCityState.flatMap { case ((countryId, _, cityAlternateNames, state), cityIds) \u003d\u003e\n    cityAlternateNames.map(n \u003d\u003e (countryId, n, state) -\u003e cityIds)\n}.reduceByKey(_ ++\u003d _).collect().toMap)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "title": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431524849771_-1728373576",
      "id": "20150513-134729_1629650484",
      "dateCreated": "May 13, 2015 1:47:29 PM",
      "dateStarted": "Mar 4, 2016 10:12:33 AM",
      "dateFinished": "Mar 4, 2016 10:12:50 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Metrics",
      "text": "println(\"(country, city): \" + citiesMap.value.size)\nprintln(\"(country, state, city): \" + statesMap.value.size)\n\nprintln(\"alternate (country, city): \" + citiesAlternateMap.value.size)\nprintln(\"alternate (country, state, city): \" + statesAlternateMap.value.size)\n\nprintln()\n\nprintln(\"ambiguous (country, city): \" + citiesMap.value.filter { case (_, cityIds) \u003d\u003e cityIds.size \u003e 1 }.size)\nprintln(\"ambiguous (country, city, state): \" + statesMap.value.filter { case (_, cityIds) \u003d\u003e cityIds.size \u003e 1 }.size)\n\nprintln(\"alternate ambiguous (country, city): \" + citiesAlternateMap.value.filter { case (_, cityIds) \u003d\u003e cityIds.size \u003e 1 }.size)\nprintln(\"alternate ambiguous (country, city, state): \" + statesAlternateMap.value.filter { case (_, cityIds) \u003d\u003e cityIds.size \u003e 1 }.size)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "editorHide": false,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "tableHide": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431526647891_-907914898",
      "id": "20150513-141727_1735310683",
      "dateCreated": "May 13, 2015 2:17:27 PM",
      "dateStarted": "Mar 4, 2016 10:12:33 AM",
      "dateFinished": "Mar 4, 2016 10:12:51 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "",
      "text": "case class Extracted(\n    block0: String,\n    block1: String,\n    block2: Option[String],\n    //\n    text0: Option[String],\n    text1: Option[String],\n    text2: Option[String],\n    //\n    country: Option[String],\n    state: Option[String],\n    city1: Option[String],\n    city2: Option[String],\n    //\n    countryId: Option[Int],\n    cityIds: Option[Seq[Int]],\n    //\n    isIdentified: Boolean,\n    isAmbiguous: Boolean)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": false,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431527090988_-1482533829",
      "id": "20150513-142450_291273855",
      "dateCreated": "May 13, 2015 2:24:50 PM",
      "dateStarted": "Mar 4, 2016 10:12:50 AM",
      "dateFinished": "Mar 4, 2016 10:12:51 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "GeoNames city matching algorithm",
      "text": "val text \u003d \"(?\u003c\u003d^| )[a-z \u0026]+(?\u003d |$)\".r\nval usState \u003d \"^([a-z]{2})( [0-9]{5})? usa$\".r\nval nlPostalCode \u003d \"\"\"^nl\\-[0-9]{4} [a-z]{2} ([a-z]+)$\"\"\".r\nval dkCityName \u003d \"^(.*) [a-z]{1}$\".r\n\ndef auStateName(s: String): Option[String] \u003d stateNameMapping.value.get(s)\n\ndef identifyCity(blocks: Seq[String]): Extracted \u003d {\n    val parts \u003d blocks.reverse\n    \n    val block0 \u003d parts(0)\n    val block1 \u003d parts(1)\n    val block2 \u003d parts.lift(2)\n    \n    val text0 \u003d text.findFirstIn(block0)\n    val text1 \u003d text.findFirstIn(block1)\n    val text2 \u003d block2.map(b2 \u003d\u003e text.findFirstIn(b2)).flatten\n    \n    var country: Option[String] \u003d None\n    var state: Option[String] \u003d None\n    var city1: Option[String] \u003d None\n    var city2: Option[String] \u003d None\n    \n    var countryId: Option[Int] \u003d None\n    var auState: Boolean \u003d false\n    \n    val cityIds \u003d\n        text0.map(properCountryName).map { t0 \u003d\u003e\n            country \u003d Some(t0)\n            val countries \u003d countriesMap.value\n            countries.get(t0) orElse\n            usState.findFirstMatchIn(block0).map { o \u003d\u003e state \u003d Some(o.group(1)); country \u003d Some(\"united states\"); 6252001 } orElse\n            ukStatesMap.value.get(t0).map { s \u003d\u003e state \u003d Some(s); country \u003d Some(\"united kingdom\"); 2635167 }\n        }.flatten.map { cid \u003d\u003e\n            countryId \u003d Some(cid)\n            text1.map(properCityName).map { t1 \u003d\u003e\n                city1 \u003d Some(t1)\n                val cities \u003d citiesMap.value\n                val states \u003d statesMap.value\n                val cities2 \u003d citiesAlternateMap.value\n                val states2 \u003d statesAlternateMap.value\n                state.map(s \u003d\u003e states.get((cid, t1, s)) orElse states2.get((cid, t1, s))).flatten orElse\n                text2.map(properCityName).map { t2 \u003d\u003e\n                    city2 \u003d Some(t2)\n                    auStateName(t1).map { s \u003d\u003e state \u003d Some(s); auState \u003d true }\n                    state.map(s \u003d\u003e states.get((cid, t2, s)) orElse states2.get((cid, t2, s))).flatten orElse\n                    cities.get((cid, t2)) orElse cities2.get((cid, t2)) orElse\n                    (states.get((cid, t2, t1)) orElse states2.get((cid, t2, t1))).map { ids \u003d\u003e state \u003d Some(t1); ids } orElse\n                    (states.get((cid, t1, t2)) orElse states2.get((cid, t1, t2))).map { ids \u003d\u003e city2 \u003d city1; state \u003d Some(t2); ids }\n                }.flatten orElse\n                {\n                    city1 \u003d\n                        nlPostalCode.findFirstMatchIn(block1).map(_.group(1)) orElse\n                        dkCityName.findFirstMatchIn(t1).map(_.group(1)) orElse\n                        (if (auState) city2 else city1)\n                    cities.get((cid, city1.get)) orElse cities2.get((cid, city1.get))\n                }\n            }.flatten\n        }.flatten\n    \n    val cityIdsSize \u003d cityIds.map(_.size).getOrElse(0)\n    val isIdentified \u003d cityIdsSize \u003d\u003d 1\n    val isAmbiguous \u003d cityIdsSize \u003e 1\n    \n    Extracted(block0, block1, block2, text0, text1, text2, country, state, city1, city2, countryId, cityIds.map(_.toSeq), isIdentified, isAmbiguous)\n}",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431527303532_-1654225428",
      "id": "20150513-142823_1810367651",
      "dateCreated": "May 13, 2015 2:28:23 PM",
      "dateStarted": "Mar 4, 2016 10:12:51 AM",
      "dateFinished": "Mar 4, 2016 10:12:52 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Sanity checks",
      "text": "/*\n- addresses are not null\n- addresses hava at least two blocks\n*/\n\nassert(institutions.filter(\"address is null\").count() \u003d\u003d 0)\nassert(institutions.filter(\"size(split(address, \u0027,\u0027)) \u003c 2\").count() \u003d\u003d 0)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431530042985_598414796",
      "id": "20150513-151402_1461671995",
      "dateCreated": "May 13, 2015 3:14:02 PM",
      "dateStarted": "Mar 4, 2016 10:12:51 AM",
      "dateFinished": "Mar 4, 2016 10:12:53 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sql select * from institutions where size(split(address, \",\")) \u003d 2",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "did",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "did",
              "index": 0.0,
              "aggr": "sum"
            }
          }
        },
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431533715604_1968459289",
      "id": "20150513-161515_472556964",
      "dateCreated": "May 13, 2015 4:15:15 PM",
      "dateStarted": "Mar 4, 2016 10:12:52 AM",
      "dateFinished": "Mar 4, 2016 10:12:53 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "import scala.util.hashing.MurmurHash3\n\ndef hash(a: Seq[String]): Long \u003d MurmurHash3.arrayHash(a.toArray).toLong\n\nval hashUDF \u003d udf { (a: Seq[String]) \u003d\u003e hash(a) }",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431539857987_283359200",
      "id": "20150513-175737_133558045",
      "dateCreated": "May 13, 2015 5:57:37 PM",
      "dateStarted": "Mar 4, 2016 10:12:53 AM",
      "dateFinished": "Mar 4, 2016 10:12:53 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "val algoBlocksUDF \u003d udf { (s: String) \u003d\u003e s.toLowerCase().split(\",\").map(_.trim).takeRight(3) }",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431539863957_1011704192",
      "id": "20150513-175743_26961043",
      "dateCreated": "May 13, 2015 5:57:43 PM",
      "dateStarted": "Mar 4, 2016 10:12:53 AM",
      "dateFinished": "Mar 4, 2016 10:12:54 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Institutions2",
      "text": "val institutions2 \u003d institutions.withColumn(\n    \"algo_blocks\", algoBlocksUDF(\u0027address)\n).withColumn(\n    \"algo_blocks_id\", hashUDF(\u0027algo_blocks)\n).persist(org.apache.spark.storage.StorageLevel.MEMORY_ONLY_SER)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431539835139_248331726",
      "id": "20150513-175715_6231438",
      "dateCreated": "May 13, 2015 5:57:15 PM",
      "dateStarted": "Mar 4, 2016 10:12:53 AM",
      "dateFinished": "Mar 4, 2016 10:12:54 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Extracted",
      "text": "val extracted \u003d institutions2.select(\u0027algo_blocks_id, \u0027algo_blocks).distinct.map { r \u003d\u003e (r.getLong(0), identifyCity(r.getSeq[String](1))) }",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "tableHide": true,
        "title": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431537321129_-1176361682",
      "id": "20150513-171521_1647330118",
      "dateCreated": "May 13, 2015 5:15:21 PM",
      "dateStarted": "Mar 4, 2016 10:12:54 AM",
      "dateFinished": "Mar 4, 2016 10:12:55 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Evaluation - Time",
      "text": "val extractedCount \u003d extracted.count()\n\n// 10 secs on 51 186 distinct (block2, block1, block0)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431531607291_718096298",
      "id": "20150513-154007_647730425",
      "dateCreated": "May 13, 2015 3:40:07 PM",
      "dateStarted": "Mar 4, 2016 10:12:54 AM",
      "dateFinished": "Mar 4, 2016 10:12:57 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "",
      "text": "def extractedPercentage(x: Long): Float \u003d (x / extractedCount.toFloat) * 100\n\ndef addMetrics(l1: Seq[Int], l2: Seq[Int]): Seq[Int] \u003d (l1, l2).zipped.map(_ + _)\n\nval metrics \u003d extracted.map { case (_, e) \u003d\u003e\n    Seq(\n        if (e.isIdentified) 1 else 0,\n        if (e.isAmbiguous) 1 else 0,\n        if (e.countryId.isEmpty) 1 else 0,\n        if (e.cityIds.isEmpty) 1 else 0)\n}.aggregate(Seq.fill(4)(0))(addMetrics, addMetrics).map(_.toLong)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": false,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431535337809_695623439",
      "id": "20150513-164217_671794892",
      "dateCreated": "May 13, 2015 4:42:17 PM",
      "dateStarted": "Mar 4, 2016 10:12:55 AM",
      "dateFinished": "Mar 4, 2016 10:13:00 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Evaluation - Quality",
      "text": "println(\"Metrics on distinct (block2, block1, block0) in lower case:\")\n\nSeq(\n    (extractedCount, \"total\"),\n    (metrics(0), \"identified\"),\n    (metrics(1), \"ambiguous\"),\n    (metrics(2), \"no country\"),\n    (metrics(3), \"no city\")\n).map {\n    case (m, label) \u003d\u003e f\"$m%.0f (${extractedPercentage(m)}%.2f %%) $label\"\n}.foreach(println)",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "editorHide": false,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "tableHide": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431535331393_235833179",
      "id": "20150513-164211_754207811",
      "dateCreated": "May 13, 2015 4:42:11 PM",
      "dateStarted": "Mar 4, 2016 10:12:58 AM",
      "dateFinished": "Mar 4, 2016 10:13:00 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Known city identification issues",
      "text": "%md\n\n##### ambiguous\nCan\u0027t be safely disambiguated without more information (ex: \u0027Univ Childrens Hosp, Munster, Germany\u0027).\nGeoNames postal codes from alternateNames.txt seem not to be correct (ex: \u0027D-79104 Freiburg, Germany\u0027).\n\n##### no country\n\u0027AN (the Netherlands Antilles) with geonameId \u003d 3513447  was dissolved on 10 October 2010\u0027\n\n##### no city\n- city contains abbreviation(s) not yet expanded\n- city has spelling mistakes\n- city in allCountries.txt\n- only county (no city)\n- not in GeoNames",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "editorHide": false,
        "editorMode": "ace/mode/markdown",
        "enabled": true,
        "tableHide": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431537868614_-834353847",
      "id": "20150513-172428_546155536",
      "dateCreated": "May 13, 2015 5:24:28 PM",
      "dateStarted": "Mar 4, 2016 10:12:13 AM",
      "dateFinished": "Mar 4, 2016 10:12:13 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "extracted.values.toDF().persist(org.apache.spark.storage.StorageLevel.MEMORY_ONLY_SER).registerTempTable(\"extracted\")",
      "dateUpdated": "Mar 4, 2016 5:35:18 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "tableHide": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431535329801_-727578067",
      "id": "20150513-164209_167677103",
      "dateCreated": "May 13, 2015 4:42:09 PM",
      "dateStarted": "Mar 4, 2016 10:13:00 AM",
      "dateFinished": "Mar 4, 2016 10:13:00 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Identified",
      "text": "%sql select distinct * from extracted where isIdentified \u003d true limit 8",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "block0",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "block1",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "block0",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "block1",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431538712466_-663886538",
      "id": "20150513-173832_1391676142",
      "dateCreated": "May 13, 2015 5:38:32 PM",
      "dateStarted": "Mar 4, 2016 10:13:00 AM",
      "dateFinished": "Mar 4, 2016 10:13:04 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Ambiguous",
      "text": "%sql select distinct * from extracted where isAmbiguous \u003d true limit 8",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "block0",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "block1",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "block0",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "block1",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431538778009_-1078787058",
      "id": "20150513-173938_1776542189",
      "dateCreated": "May 13, 2015 5:39:38 PM",
      "dateStarted": "Mar 4, 2016 10:13:00 AM",
      "dateFinished": "Mar 4, 2016 10:13:08 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "No country",
      "text": "%sql select distinct * from extracted where countryId is null limit 8",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "block0",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "block1",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "block0",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "block1",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431538776513_-515514669",
      "id": "20150513-173936_20545141",
      "dateCreated": "May 13, 2015 5:39:36 PM",
      "dateStarted": "Mar 4, 2016 10:13:04 AM",
      "dateFinished": "Mar 4, 2016 10:13:12 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "No city - 1/2",
      "text": "%sql select distinct * from extracted where cityIds is null limit 8",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "block0",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "block1",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "block0",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "block1",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431538866997_2129588047",
      "id": "20150513-174106_2097758936",
      "dateCreated": "May 13, 2015 5:41:06 PM",
      "dateStarted": "Mar 4, 2016 10:13:08 AM",
      "dateFinished": "Mar 4, 2016 10:13:15 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "No city - 2/2",
      "text": "%sql\nselect count(*) c, countryId, country, state, city1, city2\nfrom extracted\nwhere cityIds is null\ngroup by countryId, country, state, city1, city2\norder by c, countryId, state, city1, city2 desc\nlimit 8",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "c",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "countryId",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "c",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "countryId",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/sql",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431538891774_1286633855",
      "id": "20150513-174131_895865773",
      "dateCreated": "May 13, 2015 5:41:31 PM",
      "dateStarted": "Mar 4, 2016 10:13:12 AM",
      "dateFinished": "Mar 4, 2016 10:13:20 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Institutions3",
      "text": "val identified \u003d extracted.filter(_._2.isIdentified).map { case (blocksId, e) \u003d\u003e (blocksId, e.cityIds.map(_.head)) }.toDF(\"algo_geo_id\", \"city_geoname_id\")\n\nval institutions3 \u003d institutions2.join(\n    identified, \u0027algo_blocks_id \u003d\u003d\u003d \u0027algo_geo_id, \"left_outer\"\n).select(\n    // original fields\n    \u0027pub_id, \u0027idx, \u0027address, \u0027enhanced_names,\n    // GeoNames identification result fields\n    \u0027city_geoname_id\n    // GeoNames identification debug fields\n    //\u0027algo_geo_id\n).coalesce(NumPartitions).persist(org.apache.spark.storage.StorageLevel.MEMORY_ONLY_SER)",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431538354544_-1425042455",
      "id": "20150513-173234_795512113",
      "dateCreated": "May 13, 2015 5:32:34 PM",
      "dateStarted": "Mar 4, 2016 10:13:16 AM",
      "dateFinished": "Mar 4, 2016 10:13:20 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Sanity checks",
      "text": "/*\n- no institution lost\n*/\n\nassert(institutions3.count() \u003d\u003d institutions.count())",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "tableHide": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431541467666_-517958388",
      "id": "20150513-182427_1107570614",
      "dateCreated": "May 13, 2015 6:24:27 PM",
      "dateStarted": "Mar 4, 2016 10:13:20 AM",
      "dateFinished": "Mar 4, 2016 10:13:25 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "title": "Write",
      "text": "OptSaveMode.foreach(institutions3.write.mode(_).parquet(s\"$DisambigDir/geonames_city_identified_institutions-did_$DatasetId.parquet\"))",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "title": true,
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "tableHide": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431538412426_1052648516",
      "id": "20150513-173332_41945377",
      "dateCreated": "May 13, 2015 5:33:32 PM",
      "dateStarted": "Mar 4, 2016 10:13:21 AM",
      "dateFinished": "Mar 4, 2016 10:13:26 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "institutions3.show()",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "tableHide": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431541657941_-2125394965",
      "id": "20150513-182737_2079557620",
      "dateCreated": "May 13, 2015 6:27:37 PM",
      "dateStarted": "Mar 4, 2016 10:13:25 AM",
      "dateFinished": "Mar 4, 2016 10:13:26 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "",
      "dateUpdated": "Mar 4, 2016 5:35:19 PM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "editorMode": "ace/mode/scala",
        "enabled": true,
        "tableHide": true,
        "editorHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "jobName": "paragraph_1431962939949_-2027535336",
      "id": "20150518-152859_2028884895",
      "dateCreated": "May 18, 2015 3:28:59 PM",
      "dateStarted": "Mar 4, 2016 10:13:26 AM",
      "dateFinished": "Mar 4, 2016 10:13:26 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    }
  ],
  "name": "[24] GeoNames city identification",
  "id": "2APC134DG",
  "angularObjects": {},
  "config": {
    "looknfeel": "default"
  },
  "info": {}
}